# Agile AI - GitHub Actions Workflow
# Copy this file to your repository at: .github/workflows/claude-code-jira.yml
#
# Required GitHub Secrets:
#   ANTHROPIC_API_KEY  - Your Anthropic API key (https://console.anthropic.com)
#   GIT_TOKEN          - GitHub PAT with repo + PR permissions
#   FORGE_WEBHOOK_URL  - Your Forge web trigger URL (get this after `forge install`, see README)
#
# This workflow is triggered by Agile AI from Jira via workflow_dispatch.

name: Agile AI - Generate Code from Jira Issue

on:
  workflow_dispatch:
    inputs:
      issue_key:
        description: "Jira issue key (e.g., PROJ-123)"
        required: true
        type: string
      issue_title:
        description: "Jira issue title/summary"
        required: true
        type: string
      issue_description:
        description: "Jira issue description (plain text)"
        required: false
        type: string
        default: ""
      base_branch:
        description: "Base branch to create the feature branch from"
        required: false
        type: string
        default: "main"

jobs:
  generate-code:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.base_branch }}
          fetch-depth: 0

      - name: Generate code with Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          prompt: |
            You are Agile AI, an AI developer that implements code changes based on Jira issues.

            ## Jira Issue: ${{ inputs.issue_key }}
            **Title:** ${{ inputs.issue_title }}
            **Description:**
            ${{ inputs.issue_description }}

            ## Instructions
            1. Read and understand the Jira issue above.
            2. Explore the repository structure to understand the codebase, conventions, and tech stack.
            3. Implement the code changes needed to resolve this issue.
            4. Keep changes minimal and focused on the issue requirements.
            5. Follow the project's existing code style and conventions.
            6. Create or update only the files necessary to address the issue.
            7. After making all changes, create a git branch named "ai/${{ inputs.issue_key }}-<short-kebab-description>" from the current branch, commit all changes with a clear commit message prefixed with "[${{ inputs.issue_key }}]", and push the branch.
            8. Then create a pull request targeting the "${{ inputs.base_branch }}" branch using the gh CLI with:
               - Title: "[${{ inputs.issue_key }}] <short description>"
               - Body that includes a summary of changes, list of files changed, and a note that it was generated by Agile AI.
            9. IMPORTANT: After creating the PR, output EXACTLY this line so the workflow can parse it:
               AGILE_AI_PR_URL=<the full PR URL>

            IMPORTANT: You must actually create the branch, commit, push, and open the PR using git and gh CLI commands. Do not just describe what you would do.
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --model claude-sonnet-4-5-20250929
            --max-turns 25
            --allowedTools Bash(git:*) Bash(gh:*) Bash(npm:*) Bash(npx:*) Bash(node:*) Bash(ls:*) Bash(cat:*) Bash(find:*) Bash(grep:*) Bash(head:*) Bash(tail:*) Bash(wc:*) Read Write Edit
        env:
          GH_TOKEN: ${{ secrets.GIT_TOKEN }}

      - name: Extract PR URL
        id: extract
        if: success()
        run: |
          # Try to find the PR URL from the Claude output or from recent PRs
          PR_URL=$(gh pr list --head "ai/${{ inputs.issue_key }}" --json url --jq '.[0].url' 2>/dev/null || echo "")
          if [ -z "$PR_URL" ]; then
            # Fallback: get the most recently created PR by the bot
            PR_URL=$(gh pr list --state open --limit 1 --json url --jq '.[0].url' 2>/dev/null || echo "")
          fi
          PR_TITLE=$(gh pr list --head "ai/${{ inputs.issue_key }}" --json title --jq '.[0].title' 2>/dev/null || echo "")
          BRANCH=$(gh pr list --head "ai/${{ inputs.issue_key }}" --json headRefName --jq '.[0].headRefName' 2>/dev/null || echo "")
          CHANGED=$(gh pr list --head "ai/${{ inputs.issue_key }}" --json files --jq '.[0].files | length' 2>/dev/null || echo "0")

          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "changed=$CHANGED files changed" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GIT_TOKEN }}

      - name: Notify Jira - Success
        if: success() && steps.extract.outputs.pr_url != ''
        run: |
          curl -s -X POST "${{ secrets.FORGE_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg issueKey "${{ inputs.issue_key }}" \
              --arg status "success" \
              --arg prUrl "${{ steps.extract.outputs.pr_url }}" \
              --arg prTitle "${{ steps.extract.outputs.pr_title }}" \
              --arg branch "${{ steps.extract.outputs.branch }}" \
              --arg summary "${{ steps.extract.outputs.changed }}" \
              '{issueKey: $issueKey, status: $status, prUrl: $prUrl, prTitle: $prTitle, branch: $branch, summary: $summary}'
            )"

      - name: Notify Jira - Failure
        if: failure()
        run: |
          curl -s -X POST "${{ secrets.FORGE_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg issueKey "${{ inputs.issue_key }}" \
              --arg status "failure" \
              --arg summary "Workflow failed. Check GitHub Actions run #${{ github.run_number }} for details." \
              '{issueKey: $issueKey, status: $status, prUrl: null, prTitle: null, branch: null, summary: $summary}'
            )"
