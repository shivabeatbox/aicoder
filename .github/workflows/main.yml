name: Sprint AI - Generate Code from Jira Issue

on:
  workflow_dispatch:
    inputs:
      issue_key:
        description: "Jira issue key (e.g., PROJ-123)"
        required: true
        type: string
      issue_title:
        description: "Jira issue title/summary"
        required: true
        type: string
      issue_description:
        description: "Jira issue description (plain text)"
        required: false
        type: string
        default: ""
      base_branch:
        description: "Base branch to create the feature branch from"
        required: false
        type: string
        default: "main"

jobs:
  generate-code:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.base_branch }}
          fetch-depth: 0

      - name: Generate code with Claude Code
        uses: anthropics/claude-code-base-action@beta
        with:
          prompt: |
            You are Sprint AI, an AI developer that implements code changes based on Jira issues.

            ## Jira Issue: ${{ inputs.issue_key }}
            **Title:** ${{ inputs.issue_title }}
            **Description:**
            ${{ inputs.issue_description }}

            ## Instructions
            1. Read and understand the Jira issue above.
            2. Explore the repository structure to understand the codebase, conventions, and tech stack.
            3. Implement the code changes needed to resolve this issue.
            4. Keep changes minimal and focused on the issue requirements.
            5. Follow the project's existing code style and conventions.
            6. Create or update only the files necessary to address the issue.
            7. After making all changes, create a git branch named "ai/${{ inputs.issue_key }}-<short-kebab-description>" from the current branch, commit all changes with a clear commit message prefixed with "[${{ inputs.issue_key }}]", and push the branch.
            8. Then create a pull request targeting the "${{ inputs.base_branch }}" branch with:
               - Title: "[${{ inputs.issue_key }}] <short description>"
               - Body that includes a summary of changes, list of files changed, and a note that it was generated by Sprint AI.

            IMPORTANT: You must actually create the branch, commit, push, and open the PR using git and gh CLI commands.
          allowed_tools: "Bash(git:*),Bash(gh:*),Bash(npm:*),Bash(npx:*),Bash(node:*),Bash(ls:*),Bash(cat:*),Bash(find:*),Bash(grep:*),Bash(head:*),Bash(tail:*),Bash(wc:*),View,GlobTool,GrepTool,BatchTool"
          model: "claude-sonnet-4-5-20250929"
          max_turns: "25"
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
